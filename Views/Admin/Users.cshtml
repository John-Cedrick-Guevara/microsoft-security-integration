@model List<Secure.Models.User>

@{
  ViewData["Title"] = "Manage Users";
  Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-people"></i> User Management
    </h2>
    <a href="@Url.Action("Index", "Admin")" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  @if (TempData["SuccessMessage"] != null)
  {
    <div class="alert alert-success alert-dismissible fade show">
      <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  }

  @if (TempData["ErrorMessage"] != null)
  {
    <div class="alert alert-danger alert-dismissible fade show">
      <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  }

  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">All Users (@Model.Count)</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Failed Attempts</th>
              <th>Last Login</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @foreach (var user in Model)
            {
              <tr>
                <td>@user.UserID</td>
                <td>
                  <strong>@user.Username</strong>
                  @if (!user.IsActive)
                  {
                    <span class="badge bg-secondary">Inactive</span>
                  }
                </td>
                <td>@user.Email</td>
                <td>
                  @{
                    var roleBadge = user.Role switch
                    {
                      Secure.Models.UserRole.Admin => "bg-danger",
                      Secure.Models.UserRole.Moderator => "bg-warning text-dark",
                      _ => "bg-primary"
                    };
                  }
                  <span class="badge @roleBadge">@user.Role</span>
                </td>
                <td>
                  @if (user.LockoutEnd.HasValue && user.LockoutEnd.Value > DateTime.UtcNow)
                  {
                    <span class="badge bg-danger">
                      <i class="bi bi-lock-fill"></i> Locked
                    </span>
                  }
                  else if (!user.IsActive)
                  {
                    <span class="badge bg-secondary">Inactive</span>
                  }
                  else
                  {
                    <span class="badge bg-success">Active</span>
                  }
                </td>
                <td>
                  @if (user.FailedLoginAttempts > 0)
                  {
                    <span class="badge bg-warning text-dark">@user.FailedLoginAttempts</span>
                  }
                  else
                  {
                    <span class="text-muted">0</span>
                  }
                </td>
                <td>
                  @if (user.LastLogin.HasValue)
                  {
                    @user.LastLogin.Value.ToString("MM/dd/yyyy HH:mm")
                  }
                  else
                  {
                    <span class="text-muted">Never</span>
                  }
                </td>
                <td>@user.CreatedAt.ToString("MM/dd/yyyy")</td>
                <td>
                  <div class="btn-group" role="group">
                    @if (user.LockoutEnd.HasValue && user.LockoutEnd.Value > DateTime.UtcNow)
                    {
                      <form asp-action="UnlockUser" asp-controller="Admin" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@user.UserID" />
                        <button type="submit" class="btn btn-sm btn-success" title="Unlock Account">
                          <i class="bi bi-unlock"></i>
                        </button>
                      </form>
                    }

                    <form asp-action="ToggleActiveStatus" asp-controller="Admin" method="post" class="d-inline">
                      @Html.AntiForgeryToken()
                      <input type="hidden" name="userId" value="@user.UserID" />
                      <button type="submit" class="btn btn-sm btn-warning"
                        title="@(user.IsActive ? "Deactivate" : "Activate")">
                        <i class="bi bi-@(user.IsActive ? "x-circle" : "check-circle")"></i>
                      </button>
                    </form>

                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-sm btn-info dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-gear"></i>
                      </button>
                      <ul class="dropdown-menu">
                        @foreach (Secure.Models.UserRole role in Enum.GetValues(typeof(Secure.Models.UserRole)))
                        {
                          <li>
                            <form asp-action="ChangeRole" asp-controller="Admin" method="post">
                              @Html.AntiForgeryToken()
                              <input type="hidden" name="userId" value="@user.UserID" />
                              <input type="hidden" name="newRole" value="@role" />
                              <button type="submit" class="dropdown-item @(user.Role == role ? "active" : "")">
                                @role
                              </button>
                            </form>
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>